---
- block:
  - set_fact:
      ekara_volumes_tmp: []

  - set_fact:
      ekara_volumes_tmp: "{{ ekara_volumes_tmp + [item | combine({'device_name': item.params.device_name})] }}"
    with_items: "{{ek_config.volumes}}"
    when: item.device_name is not defined

  - set_fact:
      ekara_volumes_tmp: "{{ ekara_volumes_tmp + [item] }}"
    with_items: "{{ek_config.volumes}}"
    when: item.device_name is defined

  - set_fact:
      ek_config: "{{ek_config | combine({'volumes': ekara_volumes_tmp})}}"

  - set_fact:
      ekara_volumes_tags: {}
      ekara_volumes_devices: {}

  - set_fact:
      ekara_volumes: "{{ (ekara_volumes|default({})) | combine({item.params.device_name: item.path}) }}"
      ekara_volumes_tags: "{{ ekara_volumes_tags | combine( {item.params.device_name: item.params.tags|default({})} ) }}"
      ekara_volumes_devices: "{{ ekara_volumes_devices | combine( {item.params.device_name: item.device_name} ) }}"
    with_items: "{{ek_config.volumes}}"

  - name: Get volumes ids
    ec2_vol:
      region: "{{item.region}}"
      instance: "{{ item.id }}"
      state: list
    with_items: "{{ ec2.tagged_instances }}"
    register: ec2_instances_volumes
    loop_control:
      label: "{{ item.block_device_mapping }}"

  - name: Tag volumes
    ec2_tag:
      region: "{{ ekara_aws_region }}"
      resource: "{{ item.1.id }}"
      tags: "{{ ekara_volumes_tags[device_name] | combine({'FSName': ekara_volumes[device_name]}) }}"
    vars:
    - device_name: "{{item.1.attachment_set.device}}"
    with_subelements:
    - "{{ ec2_instances_volumes.results }}"
    - volumes
    loop_control:
      label: "{{ item.1.id }} - {{ item.1.attachment_set.device }}"
    when:
    - ekara_volumes_tags[device_name] is defined
